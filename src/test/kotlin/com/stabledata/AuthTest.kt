package com.stabledata

import io.ktor.client.request.*
import io.ktor.client.statement.*
import io.ktor.http.*
import io.ktor.server.testing.*
import kotlin.test.Test
import kotlin.test.assertEquals
import kotlin.test.assertNotNull


// const val NODE_GENERATED_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImJlbiJ9.92gaKus91nY1UP22qwfDABP7o1l59kJ2HbnBEfwiyqc"
const val NODE_GENERATED_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyXzAxSFJUQ1JIUDlWWDRCNFRGMFBONlRUM0NSIiwiaWF0IjoxNzI1MTk5MTg2LCJleHAiOjE3MjU3MTc1ODYsIm9iamVjdCI6InVzZXIiLCJpZCI6InVzZXJfMDFIUlRDUkhQOVZYNEI0VEYwUE42VFQzQ1IiLCJlbWFpbCI6ImVtYWlsQGJlbmlwc2VuLmNvbSIsImVtYWlsVmVyaWZpZWQiOnRydWUsImZpcnN0TmFtZSI6IkJlbiIsInByb2ZpbGVQaWN0dXJlVXJsIjoiaHR0cHM6Ly93b3Jrb3NjZG4uY29tL2ltYWdlcy92MS9CSHU2N0lwaVphOElfWWoxaG9JdkdNb2hhRS1fd01zV0d3cnpIaEFjRFkwIiwibGFzdE5hbWUiOiJJcHNlbiIsImNyZWF0ZWRBdCI6IjIwMjQtMDMtMTJUMjI6MzM6MDYuNDY0WiIsInVwZGF0ZWRBdCI6IjIwMjQtMDUtMDFUMjA6NDc6NDIuMzUxWiJ9.qN8C21DVMbrasjH4EcFGAzS0dwQysfjAioEU1pyhR0U"
class AuthTest {

    @Test
    fun `authorizes calls with node generated tokens` () = testApplication {
        application {
            module()
        }

        val response = client.get("/secure") {
            headers {
                append(HttpHeaders.Authorization, "Bearer $NODE_GENERATED_TOKEN")
            }

        }
        assertEquals(HttpStatusCode.OK, response.status)
        assertEquals("secured", response.bodyAsText())
    }

    @Test
    fun `authorizes calls with ktor generated tokens` () = testApplication {
        application {
            module()
        }

        val token = generateJwtTokenWithCredentials(UserCredentials("ben"))
        val response = client.get("/secure") {
            headers {
                append(HttpHeaders.Authorization, "Bearer $token")
            }

        }
        assertEquals(HttpStatusCode.OK, response.status)
        assertEquals("secured", response.bodyAsText())
    }

    @Test
    fun `generate JWT` () {
        val jwt = generateJwtTokenWithCredentials(UserCredentials("ben"))
        println(jwt)
    }

    @Test
    fun `verify JWT` () {
        configureLogging()
        // this token was generated by jose lib.
        // of note, others did not seem to work
        val v = verifyToken(NODE_GENERATED_TOKEN)
        assertNotNull(v)
    }
}